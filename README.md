# rating-importer
Imports data from [rating.chgk.info](https://rating.chgk.info) for [rating.maii.li](https://rating.maii.li) calculations.

## Rake tasks
All imports are rake tasks (defined in [`Rakefile`](./Rakefile)). Each task is responsible for one resource (tournament details, tournament roster, team, town, etc.).

## Import strategy
For each import, we:
* create a temporary table (e.g., `teams_temp`);
* import data into this temporary table;
* record IDs of imported records into `@ids` (not autogenerated IDs from Postgres, but those provided by [rating.chgk.info](https://rating.chgk.info));
* set `updated_at` for each imported row to `DateTime.now`;
* in one transaction, delete from the main table all rows with IDs from `@ids` and insert everything from the temp table. 

This is defined in [`strategies/temp_table.rb`](strategies/temp_table.rb)

## Refresh data for one tournament

```bash
fly ssh console
cd app
bundle exec rake tournaments:results_for_single_tournament[6341]
```

Replace 6341 with the ID of the tournament you want to update. 

## Deployment
rating-b runs on [Fly](https://fly.io/). Deployment is defined in [`fly.toml`](./fly.toml) and has one process: `supercronic /app/crontab`.

[Supercronic](https://github.com/aptible/supercronic) is [recommended by Fly for cron jobs](https://fly.io/docs/app-guides/supercronic/): it loads environment variables, forwards job logs to stdout and stderr, and handles sigterm signals. We install it in the final section of [`Dockerfile`](./Dockerfile).

Cron jobs are set up in [`crontab`](./crontab).
